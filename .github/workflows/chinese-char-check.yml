name: "Check Chinese Characters in PR Changes"

on:
  pull_request:
    types: [opened, edited, synchronize]
    paths:
      - "tencentcloud/**"
      - "website/**"

permissions:
  contents: read
  pull-requests: read  # Êñ∞Â¢ûÔºöËé∑ÂèñPRËØ¶ÊÉÖÁöÑÊùÉÈôê

jobs:
  chinese-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # ÂÖ≥ÈîÆÔºöÊãâÂèñbaseÂàÜÊîØÔºåÁ°Æ‰øùdiffÂØπÊØîÂáÜÁ°Æ
          ref: ${{ github.event.pull_request.base.ref }}

      - name: Fetch PR head branch
        run: |
          # ÊãâÂèñÂΩìÂâçPRÁöÑHEADÂàÜÊîØÔºàÁ°Æ‰øùËÉΩÂØπÊØîÔºâ
          git fetch origin ${{ github.event.pull_request.head.ref }}:refs/remotes/origin/${{ github.event.pull_request.head.ref }}

      - name: Get changed files (only current PR)
        id: changed
        uses: yumemi-inc/changed-files@v3
        with:
          # ÊòéÁ°ÆÊåáÂÆöÂØπÊØîÁöÑÂàÜÊîØÔºöbase vs PR head
          base: ${{ github.event.pull_request.base.sha }}
          head: ${{ github.event.pull_request.head.sha }}
          patterns: |
            tencentcloud/services/**
            website/**
          format: json
          # ‰ªÖËé∑ÂèñÊñ∞Â¢û/‰øÆÊîπÁöÑÊñá‰ª∂ÔºàÊéíÈô§Âà†Èô§ÁöÑÔºâ
          filter: added_modified

      - name: No relevant files - skip check
        if: steps.changed.outputs.exists != 'true'
        run: |
          echo "‚ÑπÔ∏è No changed files in target directories (tencentcloud/ or website/)"
          echo "Chinese character check skipped."

      - name: Check for Chinese characters (only PR changes)
        if: steps.changed.outputs.exists == 'true'
        run: |
          # ‰øÆÂ§çÔºöÁî®whileÂæ™ÁéØËß£ÊûêJSONÔºåÈÅøÂÖçÁ©∫Ê†ºË∑ØÂæÑÈóÆÈ¢ò
          found=false
          violations="chinese_violations.txt"
          > "$violations"
          export LC_ALL=en_US.UTF-8

          # Ê≠£Á°ÆËß£ÊûêJSONÊï∞ÁªÑÔºàÂÖºÂÆπÂê´Á©∫Ê†ºÁöÑÊñá‰ª∂Ë∑ØÂæÑÔºâ
          echo '${{ steps.changed.outputs.files }}' | jq -r '.[]' | while read -r file; do
            [ -z "$file" ] && continue
            [ ! -f "$file" ] && echo "‚ö†Ô∏è File $file not found, skip" && continue
            
            # Ë∑≥Ëøá‰∫åËøõÂà∂Êñá‰ª∂
            if file --mime-type "$file" | grep -q 'binary/'; then
              echo "‚ö†Ô∏è Skipping binary file: $file"
              continue
            fi

            # „ÄêÂèØÈÄâ‰ºòÂåñ„Äë‰ªÖÊ£ÄÊµãPR‰øÆÊîπÁöÑË°åÔºàËÄåÈùûÂÖ®Êñá‰ª∂Ôºâ
            # Ëé∑ÂèñPR‰∏≠ËØ•Êñá‰ª∂ÁöÑÂèòÂä®Ë°å
            changed_lines=$(git diff -U0 ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} -- "$file" | grep -E '^\+[^+]' | sed 's/^\+//')
            
            # Ëã•ÂèòÂä®Ë°åÈùûÁ©∫ÔºåÊ£ÄÊµãÂÖ∂‰∏≠ÁöÑ‰∏≠ÊñáÂ≠óÁ¨¶
            if [ -n "$changed_lines" ]; then
              # Â∞ÜÂèòÂä®Ë°åÂÜôÂÖ•‰∏¥Êó∂Êñá‰ª∂Ê£ÄÊµã
              echo "$changed_lines" > temp_changed_lines.txt
              if grep -Pn -o "[\u4e00-\u9fff\u3400-\u4dbf\uf900-\ufaff\u3000-\u303f\uff00-\uffef]" temp_changed_lines.txt; then
                echo -e "\n‚ùå Chinese characters found in PR changes of file: $file" | tee -a "$violations"
                echo "Changed lines with Chinese characters:" | tee -a "$violations"
                grep -Pn "[\u4e00-\u9fff\u3400-\u4dbf\uf900-\ufaff\u3000-\u303f\uff00-\uffef]" temp_changed_lines.txt | tee -a "$violations"
                echo -e "\n" | tee -a "$violations"
                found=true
              fi
              rm -f temp_changed_lines.txt
            else
              echo "‚úÖ No changed lines in $file, skip check"
            fi
          done

          if $found; then
            echo -e "\nüö´ Validation failed: Chinese characters detected in PR changes!"
            cat "$violations"
            rm -f "$violations"
            exit 1
          else
            echo -e "\n‚úÖ Validation passed: No Chinese characters in PR changes!"
            rm -f "$violations"
          fi

      - name: Cleanup
        if: always()
        run: rm -f chinese_violations.txt temp_changed_lines.txt
